services:
  php:
    build:
      context: .
      dockerfile: docker/php/Dockerfile
    container_name: webci-php
    volumes:
      - ./:/app
      - composer-cache:/root/.composer/cache
    env_file:
      - env/docker.env

  frontend:
    image: nginx:1.27-alpine
    container_name: webci-frontend
    depends_on:
      - php
    ports:
      - "${FRONTEND_PORT:-3080}:80"
    volumes:
      - ./:/app:delegated
      - ./docker/nginx/frontend.conf:/etc/nginx/conf.d/default.conf:ro

  backend:
    image: nginx:1.27-alpine
    container_name: webci-backend
    depends_on:
      - php
    ports:
      - "${BACKEND_PORT:-3180}:80"
    volumes:
      - ./:/app:delegated
      - ./docker/nginx/backend.conf:/etc/nginx/conf.d/default.conf:ro

  mysql:
    image: mysql:8.0
    container_name: webci-mysql
    restart: unless-stopped
    env_file:
      - env/docker.env
    environment:
      - MYSQL_ROOT_PASSWORD=${DB_ROOT_PASSWORD:-verysecret}
      - MYSQL_DATABASE=${DB_NAME:-webci}
      - MYSQL_USER=${DB_USER:-webci}
      - MYSQL_PASSWORD=${DB_PASSWORD:-secret}
    volumes:
      - mysql-data:/var/lib/mysql
    ports:
      - "${MYSQL_PORT:-3309}:3306"

  mailhog:
    image: mailhog/mailhog:v1.0.1
    container_name: webci-mailhog
    ports:
      - "${MAILHOG_SMTP_PORT:-1028}:1025"
      - "${MAILHOG_UI_PORT:-8028}:8025"

  phpmyadmin:
    image: phpmyadmin/phpmyadmin:5.2
    container_name: webci-phpmyadmin
    depends_on:
      - mysql
    env_file:
      - env/docker.env
    environment:
      - PMA_HOST=mysql
      - PMA_PORT=3306
      - PMA_USER=${DB_USER:-webci}
      - PMA_PASSWORD=${DB_PASSWORD:-secret}
    ports:
      - "${PHPMYADMIN_PORT:-9090}:80"
    restart: unless-stopped

volumes:
  composer-cache:
  mysql-data: